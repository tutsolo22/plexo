# üìã FASE 2D: Sistema de Cotizaciones Avanzado + Gestor de Plantillas

## üéØ **Objetivos de la Fase 2D**

Implementar un **Sistema de Cotizaciones Avanzado** integrado con un **Gestor de Plantillas Visual**, permitiendo:

1. **üíº Cotizaciones Profesionales** - Generaci√≥n autom√°tica con plantillas personalizables
2. **üìù Gestor de Plantillas** - Editor visual para crear y gestionar plantillas
3. **üìÑ Generaci√≥n PDF** - PDFs profesionales con dise√±os personalizados
4. **üìß Env√≠o Autom√°tico** - Sistema de email con seguimiento
5. **üîó Integraci√≥n Total** - Conexi√≥n fluida con eventos y clientes

---

## üóÇÔ∏è **Arquitectura del Sistema**

### **1. Modelo de Datos - Templates**

```prisma
model Template {
  id          String   @id @default(cuid())
  name        String   // "Cotizaci√≥n Eventos Sociales"
  description String?  // Descripci√≥n del template
  type        TemplateType // QUOTE, CONTRACT, INVOICE, EMAIL
  category    String?  // "eventos", "bodas", "corporativo"
  
  // Contenido del template
  content     Json     // HTML/Texto con variables {{variable}}
  variables   Json     // ["clientName", "eventDate", "totalAmount"]
  styles      Json?    // CSS styles para PDF
  
  // Metadata
  isActive    Boolean  @default(true)
  isDefault   Boolean  @default(false)
  version     Int      @default(1)
  
  // Relaciones
  createdBy   String
  creator     User     @relation(fields: [createdBy], references: [id])
  quotes      Quote[]  // Cotizaciones usando este template
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

enum TemplateType {
  QUOTE       // Cotizaciones
  CONTRACT    // Contratos
  INVOICE     // Facturas
  EMAIL       // Templates de email
  PROPOSAL    // Propuestas comerciales
}
```

### **2. Modelo de Datos - Quotes Extendido**

```prisma
model Quote {
  id              String      @id @default(cuid())
  
  // Informaci√≥n b√°sica (ya existente)
  clientId        String
  client          Client      @relation(fields: [clientId], references: [id])
  
  // NUEVO: Template y generaci√≥n
  templateId      String?
  template        Template?   @relation(fields: [templateId], references: [id])
  
  // NUEVO: Contenido generado
  generatedContent Json?      // HTML final con variables reemplazadas
  pdfUrl          String?     // URL del PDF generado
  
  // NUEVO: Versioning y estados
  version         Int         @default(1)
  previousVersion String?     // ID de versi√≥n anterior
  
  // NUEVO: Env√≠o y seguimiento
  sentAt          DateTime?   // Cu√°ndo se envi√≥
  viewedAt        DateTime?   // Cu√°ndo fue vista por el cliente
  respondedAt     DateTime?   // Cu√°ndo respondi√≥ el cliente
  
  // Campos existentes...
  status          QuoteStatus @default(DRAFT)
  validUntil      DateTime
  notes           String?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
}

enum QuoteStatus {
  DRAFT           // Borrador
  SENT            // Enviada
  VIEWED          // Vista por cliente
  ACCEPTED        // Aceptada
  REJECTED        // Rechazada
  EXPIRED         // Expirada
  REVISED         // Revisada
}
```

---

## üîß **APIs a Implementar**

### **1. APIs de Cotizaciones (/api/quotes)**

#### **CRUD Principal**
```typescript
GET    /api/quotes               // Lista con filtros avanzados
POST   /api/quotes               // Crear cotizaci√≥n
GET    /api/quotes/[id]          // Detalle completo
PUT    /api/quotes/[id]          // Actualizar
DELETE /api/quotes/[id]          // Eliminar
```

#### **Funcionalidades Avanzadas**
```typescript
POST   /api/quotes/[id]/generate    // Generar contenido con template
GET    /api/quotes/[id]/pdf         // Generar/descargar PDF
POST   /api/quotes/[id]/send        // Enviar por email
POST   /api/quotes/[id]/duplicate   // Duplicar cotizaci√≥n
GET    /api/quotes/[id]/versions    // Historial de versiones
POST   /api/quotes/[id]/accept      // Aceptar cotizaci√≥n (cliente)
```

### **2. APIs de Plantillas (/api/templates)**

#### **CRUD Principal**
```typescript
GET    /api/templates            // Lista por categor√≠a/tipo
POST   /api/templates            // Crear template
GET    /api/templates/[id]       // Detalle completo
PUT    /api/templates/[id]       // Actualizar
DELETE /api/templates/[id]       // Eliminar
```

#### **Funcionalidades Especiales**
```typescript
POST   /api/templates/[id]/preview     // Vista previa con datos
POST   /api/templates/[id]/duplicate   // Duplicar template
GET    /api/templates/variables        // Variables disponibles
POST   /api/templates/[id]/test        // Probar template
GET    /api/templates/categories       // Categor√≠as disponibles
```

---

## üé® **Componentes a Desarrollar**

### **1. TemplateEditor.tsx - Editor Visual**

```typescript
interface TemplateEditorProps {
  template?: Template;
  onSave: (data: TemplateFormData) => void;
  onCancel: () => void;
}

// Funcionalidades:
// ‚úÖ Editor WYSIWYG (TinyMCE o similar)
// ‚úÖ Panel de variables arrastrables
// ‚úÖ Vista previa en tiempo real
// ‚úÖ Selector de estilos CSS
// ‚úÖ Validaci√≥n de sintaxis
// ‚úÖ Gesti√≥n de categor√≠as
```

### **2. QuoteGenerator.tsx - Generador Inteligente**

```typescript
interface QuoteGeneratorProps {
  eventId?: string;
  clientId?: string;
  templateId?: string;
  onGenerated: (quote: Quote) => void;
}

// Funcionalidades:
// ‚úÖ Selecci√≥n de template
// ‚úÖ Auto-poblaci√≥n desde evento
// ‚úÖ Editor de contenido
// ‚úÖ Calculadora de precios
// ‚úÖ Vista previa PDF
// ‚úÖ Env√≠o directo
```

### **3. PDFGenerator.tsx - Generaci√≥n PDF**

```typescript
interface PDFGeneratorProps {
  quote: Quote;
  template: Template;
  onGenerated: (pdfUrl: string) => void;
}

// Tecnolog√≠as opciones:
// - react-pdf (cliente)
// - puppeteer (servidor)
// - jsPDF (ligero)
// - PDF-lib (avanzado)
```

### **4. EmailComposer.tsx - Compositor Email**

```typescript
interface EmailComposerProps {
  quote: Quote;
  client: Client;
  onSent: (sentData: EmailSentData) => void;
}

// Funcionalidades:
// ‚úÖ Template de email HTML
// ‚úÖ Adjuntar PDF autom√°tico
// ‚úÖ Personalizaci√≥n de mensaje
// ‚úÖ Programar env√≠o
// ‚úÖ Seguimiento de apertura
```

---

## üì± **P√°ginas a Crear**

### **1. Sistema de Cotizaciones**

#### `/dashboard/quotes` - Vista Principal
- **Lista de cotizaciones** con filtros avanzados
- **Estados visuales** con badges coloridos
- **Acciones r√°pidas**: Ver, Editar, Duplicar, Enviar
- **B√∫squeda** por cliente, fecha, estado
- **M√©tricas** de conversi√≥n y env√≠os

#### `/dashboard/quotes/new` - Crear Cotizaci√≥n
- **Selector de template** con vista previa
- **Formulario inteligente** con auto-poblaci√≥n
- **Editor de contenido** integrado
- **Calculadora de precios** din√°mica
- **Vista previa PDF** en tiempo real

#### `/dashboard/quotes/[id]` - Detalle Cotizaci√≥n
- **Vista completa** con toda la informaci√≥n
- **Historial de versiones** y cambios
- **Timeline de seguimiento** (enviado, visto, respondido)
- **Acciones**: Editar, Enviar, Generar PDF, Duplicar
- **Panel de cliente** con informaci√≥n relevante

#### `/dashboard/quotes/[id]/edit` - Editar Cotizaci√≥n
- **Editor completo** con template
- **Control de versiones** autom√°tico
- **Comparaci√≥n** con versi√≥n anterior
- **Vista previa** en tiempo real

### **2. Gestor de Plantillas**

#### `/dashboard/templates` - Gesti√≥n de Plantillas
- **Grid de plantillas** por categor√≠as
- **Vista previa** r√°pida
- **Filtros** por tipo, categor√≠a, estado
- **Acciones**: Crear, Editar, Duplicar, Eliminar
- **Estad√≠sticas** de uso

#### `/dashboard/templates/new` - Crear Plantilla
- **Editor visual** completo
- **Selector de tipo** y categor√≠a
- **Panel de variables** disponibles
- **Vista previa** con datos de prueba

#### `/dashboard/templates/[id]/edit` - Editor Visual
- **Editor WYSIWYG** avanzado
- **Panel de variables** arrastrables
- **Vista previa** en tiempo real
- **Gestor de estilos** CSS
- **Versionado** autom√°tico

---

## üîó **Integraciones del Sistema**

### **1. Conexi√≥n con Eventos**
```typescript
// Flujo: Evento ‚Üí Cotizaci√≥n
// 1. Desde detalle de evento: "Generar Cotizaci√≥n"
// 2. Auto-popular datos del evento
// 3. Seleccionar template apropiado
// 4. Generar cotizaci√≥n vinculada
```

### **2. Conexi√≥n con Clientes**
```typescript
// Flujo: Cliente ‚Üí Historial Cotizaciones
// 1. Ver todas las cotizaciones del cliente
// 2. Estado de cada cotizaci√≥n
// 3. M√©tricas de conversi√≥n
// 4. Plantillas m√°s usadas
```

### **3. Conexi√≥n con Dashboard**
```typescript
// M√©tricas para Dashboard:
// - Cotizaciones enviadas este mes
// - Tasa de conversi√≥n
// - Templates m√°s utilizados
// - Ingresos proyectados
```

---

## üìä **Variables del Sistema**

### **Variables Globales Disponibles**
```typescript
const GLOBAL_VARIABLES = {
  // Cliente
  clientName: "{{clientName}}",
  clientEmail: "{{clientEmail}}",
  clientPhone: "{{clientPhone}}",
  clientAddress: "{{clientAddress}}",
  
  // Evento
  eventTitle: "{{eventTitle}}",
  eventDate: "{{eventDate}}",
  eventTime: "{{eventTime}}",
  eventDuration: "{{eventDuration}}",
  
  // Cotizaci√≥n
  quoteNumber: "{{quoteNumber}}",
  quoteDate: "{{quoteDate}}",
  validUntil: "{{validUntil}}",
  totalAmount: "{{totalAmount}}",
  
  // Empresa
  companyName: "{{companyName}}",
  companyAddress: "{{companyAddress}}",
  companyPhone: "{{companyPhone}}",
  companyEmail: "{{companyEmail}}",
  
  // Din√°micas
  currentDate: "{{currentDate}}",
  currentUser: "{{currentUser}}",
};
```

---

## üöÄ **Plan de Implementaci√≥n**

### **Fase 1: Estructura Base** (D√≠as 1-2)
1. ‚úÖ Crear modelos Prisma
2. ‚úÖ Implementar APIs b√°sicas
3. ‚úÖ Configurar dependencias

### **Fase 2: Templates** (D√≠as 3-4)
1. ‚úÖ Sistema de plantillas
2. ‚úÖ Editor visual b√°sico
3. ‚úÖ Variables din√°micas

### **Fase 3: Cotizaciones** (D√≠as 5-6)
1. ‚úÖ Generador de cotizaciones
2. ‚úÖ Integraci√≥n con templates
3. ‚úÖ Interface de gesti√≥n

### **Fase 4: PDF y Email** (D√≠as 7-8)
1. ‚úÖ Generaci√≥n de PDF
2. ‚úÖ Sistema de env√≠o
3. ‚úÖ Seguimiento

### **Fase 5: Integraci√≥n** (D√≠as 9-10)
1. ‚úÖ Conexi√≥n con eventos
2. ‚úÖ Dashboard metrics
3. ‚úÖ Testing completo

---

## üì¶ **Dependencias Nuevas**

```json
{
  // Editor visual
  "@tinymce/tinymce-react": "^4.x",
  
  // Generaci√≥n PDF
  "react-pdf": "^7.x",
  "@react-pdf/renderer": "^3.x",
  
  // Email
  "nodemailer": "^6.x",
  "@types/nodemailer": "^6.x",
  
  // Plantillas
  "handlebars": "^4.x",
  "mustache": "^4.x",
  
  // Utilidades
  "html2canvas": "^1.x",
  "jspdf": "^2.x"
}
```

---

## üéØ **Resultados Esperados**

Al completar la **Fase 2D**, el sistema tendr√°:

‚úÖ **Gestor de Plantillas Visual** completo  
‚úÖ **Sistema de Cotizaciones Avanzado** con PDF  
‚úÖ **Integraci√≥n total** con eventos y clientes  
‚úÖ **Env√≠o autom√°tico** con seguimiento  
‚úÖ **Editor WYSIWYG** para plantillas  
‚úÖ **Variables din√°micas** configurables  
‚úÖ **Versionado** y control de cambios  
‚úÖ **M√©tricas** de conversi√≥n integradas  

**¬øProceder con la implementaci√≥n de la Fase 2D?** üöÄ