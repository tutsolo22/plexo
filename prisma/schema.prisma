// Gestión de Eventos V3 - Schema Principal
// Basado en la experiencia de CRM Casona María

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =====================
// AUTENTICACIÓN Y USUARIOS
// =====================

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  role          UserRole  @default(USER)

  // Relaciones NextAuth.js
  accounts Account[]
  sessions Session[]

  // Auditoría básica
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones del negocio
  createdClients Client[] @relation("CreatedByUser")
  createdEvents  Event[]  @relation("CreatedByUser")
  createdQuotes  Quote[]  @relation("CreatedByUser")

  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verificationtokens")
}

// =====================
// GESTIÓN DE CLIENTES
// =====================

model Client {
  id         String     @id @default(cuid())
  name       String
  email      String?    @unique
  phone      String?
  company    String?
  clientType ClientType @default(INDIVIDUAL)

  // Información adicional
  address String?
  notes   String?

  // Auditoría
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdById String
  createdBy   User     @relation("CreatedByUser", fields: [createdById], references: [id])

  // Relaciones
  events Event[]
  quotes Quote[]

  @@map("clients")
}

// =====================
// SISTEMA DE EVENTOS
// =====================

model Event {
  id          String  @id @default(cuid())
  title       String
  description String?

  // Fechas y duración
  startDate DateTime
  endDate   DateTime
  duration  Int // Duración en horas

  // Estado y tipo
  status    EventStatus @default(QUOTED)
  eventType String

  // Capacidad y asistentes
  guestCount      Int
  confirmedGuests Int @default(0)

  // Relaciones principales
  clientId String
  client   Client @relation(fields: [clientId], references: [id])

  venueId String?
  venue   Venue?  @relation(fields: [venueId], references: [id])

  // Auditoría
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdById String
  createdBy   User     @relation("CreatedByUser", fields: [createdById], references: [id])

  // Relaciones adicionales
  quotes        Quote[]
  eventServices EventService[]
  eventProducts EventProduct[]

  @@map("events")
}

// =====================
// VENUES Y ESPACIOS
// =====================

model Venue {
  id          String  @id @default(cuid())
  name        String
  description String?
  location    String?
  capacity    Int

  // Configuración
  isActive   Boolean @default(true)
  hourlyRate Decimal @default(0)

  // Auditoría
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  events     Event[]
  quoteItems QuoteItem[]

  @@map("venues")
}

// =====================
// PRODUCTOS Y SERVICIOS
// =====================

model Product {
  id          String  @id @default(cuid())
  name        String
  description String?
  category    String?

  // Precios
  basePrice Decimal
  unit      String  @default("unidad")

  // Configuración
  isActive Boolean @default(true)

  // Auditoría
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  eventProducts EventProduct[]
  quoteItems    QuoteItem[]

  @@map("products")
}

model Service {
  id          String  @id @default(cuid())
  name        String
  description String?
  category    String?

  // Precios
  basePrice Decimal
  unit      String  @default("hora")

  // Configuración
  isActive Boolean @default(true)

  // Auditoría
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  eventServices EventService[]
  quoteItems    QuoteItem[]

  @@map("services")
}

// =====================
// COTIZACIONES
// =====================

model Quote {
  id     String @id @default(cuid())
  number String @unique // QUO-2024-001

  // Estado y fechas
  status     QuoteStatus @default(DRAFT)
  validUntil DateTime

  // Montos
  subtotal Decimal @default(0)
  tax      Decimal @default(0)
  discount Decimal @default(0)
  total    Decimal @default(0)

  // Notas
  notes String?
  terms String?

  // Relaciones principales
  clientId String
  client   Client @relation(fields: [clientId], references: [id])

  eventId String?
  event   Event?  @relation(fields: [eventId], references: [id])

  // Auditoría
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdById String
  createdBy   User     @relation("CreatedByUser", fields: [createdById], references: [id])

  // Relaciones adicionales
  items QuoteItem[]

  @@map("quotes")
}

model QuoteItem {
  id String @id @default(cuid())

  // Información del item
  name        String
  description String?
  quantity    Int
  unitPrice   Decimal
  total       Decimal

  // Tipo de item
  itemType ItemType

  // Relaciones
  quoteId String
  quote   Quote  @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  // Referencias opcionales a productos/servicios/venues
  productId String?
  product   Product? @relation(fields: [productId], references: [id])

  serviceId String?
  service   Service? @relation(fields: [serviceId], references: [id])

  venueId String?
  venue   Venue?  @relation(fields: [venueId], references: [id])

  // Auditoría
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("quote_items")
}

// =====================
// RELACIONES EVENTO-PRODUCTO/SERVICIO
// =====================

model EventProduct {
  id        String  @id @default(cuid())
  quantity  Int
  unitPrice Decimal

  eventId String
  event   Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)

  productId String
  product   Product @relation(fields: [productId], references: [id])

  createdAt DateTime @default(now())

  @@unique([eventId, productId])
  @@map("event_products")
}

model EventService {
  id        String  @id @default(cuid())
  hours     Int
  unitPrice Decimal

  eventId String
  event   Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)

  serviceId String
  service   Service @relation(fields: [serviceId], references: [id])

  createdAt DateTime @default(now())

  @@unique([eventId, serviceId])
  @@map("event_services")
}

// =====================
// ENUMS
// =====================

enum UserRole {
  USER
  MANAGER
  ADMIN
  SUPER_ADMIN
}

enum ClientType {
  INDIVIDUAL
  CORPORATE
  GOVERNMENT
  NONPROFIT
}

enum EventStatus {
  QUOTED
  RESERVED
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum QuoteStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  SENT_TO_CLIENT
  ACCEPTED
  REJECTED
  EXPIRED
}

enum ItemType {
  PRODUCT
  SERVICE
  VENUE
  CUSTOM
}
